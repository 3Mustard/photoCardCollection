const gallery = document.getElementById('gallery');
const links = document.querySelectorAll('.nav-links a');
const toTop = document.getElementById('toTop');
const loginBtn = document.getElementById('loginBtn');

const members = ['nayeon','jeongyeon','momo','sana','jihyo','mina','dahyun','chaeyoung','tzuyu'];
const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
const exts = ['jpg','jpeg','png','webp','jfif'];
const BASE_FOLDER = 'images/Twice';
const PASSWORD = 'Chaeyoung29';
let authenticated = false;

function setActive(el){
 links.forEach(l=>l.classList.remove('active'));
 if(el) el.classList.add('active');
}

function clearGallery(){
 gallery.innerHTML = '';
}

function checkImage(src){
 return new Promise(resolve => {
 const img = new Image();
 img.onload = () => resolve(true);
 img.onerror = () => resolve(false);
 img.src = src;
 });
}

// Try folder variants (lowercase and capitalized member folder) and multiple extensions
async function findExistingSrc(folder, base){
 // folder expected like 'images/Twice/member'
 const parts = folder.split('/');
 const member = parts[parts.length-1];
 const variants = [ `${BASE_FOLDER}/${member}`, `${BASE_FOLDER}/${member.charAt(0).toUpperCase() + member.slice(1)}` ];
 for(const v of variants){
 for(const ext of exts){
 const path = `${v}/${base}.${ext}`;
 // eslint-disable-next-line no-await-in-loop
 const ok = await checkImage(path);
 if(ok) return path;
 }
 }
 return null;
}

async function loadMember(member){
 clearGallery();
 setActive(document.querySelector(`.nav-links a[data-folder="${member}"]`));
 const folder = `${BASE_FOLDER}/${member}`;

 let foundAny = false;

 for(const letter of letters){
 // try to find letter1 and letter2 (a1, a2)
 const [oneSrc, twoSrc] = await Promise.all([
 findExistingSrc(folder, `${letter}1`),
 findExistingSrc(folder, `${letter}2`)
 ]);

 if(!oneSrc && !twoSrc) continue; // nothing for this pair

 foundAny = true;

 const pairDiv = document.createElement('div');
 pairDiv.className = 'pair';

 // helper to create card (either image or empty placeholder)
 const makeCard = (src) => {
 const card = document.createElement('div');
 card.className = 'card';
 if(src){
 const img = document.createElement('img');
 img.src = src;
 img.alt = '';
 img.loading = 'lazy';
 card.appendChild(img);
 } else {
 // empty slot to keep layout consistent
 const placeholder = document.createElement('div');
 placeholder.className = 'empty-slot';
 placeholder.style.width = '100%';
 placeholder.style.background = 'linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';
 placeholder.style.borderRadius = '6px';
 card.appendChild(placeholder);
 }
 return card;
 };

 pairDiv.appendChild(makeCard(oneSrc));
 pairDiv.appendChild(makeCard(twoSrc));

 gallery.appendChild(pairDiv);
 }

 if(!foundAny){
 gallery.innerHTML = `<div class="empty">No images found for ${member}. Place images in ${folder} named like a1.jpg, a2.jpg, b1.jpg, b2.jpg...</div>`;
 }
}

// Attach click handlers
links.forEach(link=>{
 link.addEventListener('click',e=>{
 e.preventDefault();
 const folder = link.dataset.folder;
 loadMember(folder);
 window.scrollTo({top:70,behavior:'smooth'});
 });
});

// scroll-to-top behavior
window.addEventListener('scroll', ()=>{
 if(window.scrollY >200){
 toTop.classList.add('show');
 } else {
 toTop.classList.remove('show');
 }
});

toTop.addEventListener('click', ()=>{
 window.scrollTo({top:0,behavior:'smooth'});
});

// login/upload behavior
loginBtn.addEventListener('click', async ()=>{
 if(authenticated){
 // act as upload trigger
 const activeLink = document.querySelector('.nav-links a.active');
 if(!activeLink){
 alert('Please select a member from the navbar before uploading.');
 return;
 }
 const member = activeLink.dataset.folder;
 // prompt for file selection
 const file = await promptForFile();
 if(!file) return;
 const filename = prompt('Enter filename to save as (without extension):');
 if(!filename) return;
 // try to save - File System Access API or fallback to download
 await saveFileForMember(member, file, filename);
 alert('Upload simulated: file prepared for saving (check downloads or FS API).');
 return;
 }

 const pass = prompt('Enter password:');
 if(pass === PASSWORD){
 authenticated = true;
 loginBtn.textContent = 'Upload';
 loginBtn.classList.add('allowed');
 } else {
 alert('Incorrect password');
 }
});

async function promptForFile(){
 // Use input element to prompt for a file
 return new Promise(resolve=>{
 const input = document.createElement('input');
 input.type = 'file';
 input.accept = 'image/*';
 input.onchange = ()=>{
 const f = input.files[0];
 resolve(f);
 };
 input.click();
 // if user cancels, resolve null later
 setTimeout(()=>resolve(null),60000);
 });
}

async function saveFileForMember(member, file, filename){
 const ext = file.name.split('.').pop();
 const outputName = `${filename}.${ext}`;
 // Try File System Access API
 try{
 if('showDirectoryPicker' in window){
 // Ask user to pick the Twice images folder (security prompt)
 const dirHandle = await window.showDirectoryPicker();
 // Ensure we are inside images/Twice/member by attempting to create the path
 let targetDir = dirHandle;
 // create or get member folder
 try{ targetDir = await dirHandle.getDirectoryHandle('Twice', {create:false}); }catch(e){}
 // best-effort: try to create member dir inside selected root
 let memberDir;
 try{ memberDir = await targetDir.getDirectoryHandle(member, {create:true}); }catch(e){ memberDir = targetDir; }
 const fileHandle = await memberDir.getFileHandle(outputName, {create:true});
 const writable = await fileHandle.createWritable();
 await writable.write(await file.arrayBuffer());
 await writable.close();
 return;
 }
 }catch(e){
 // fall through to fallback
 }

 // Fallback: create downloadable blob link
 const blob = await file.slice(0, file.size, file.type);
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `${member}-${outputName}`;
 document.body.appendChild(a);
 a.click();
 a.remove();
 URL.revokeObjectURL(url);
}

// Load first member on startup
loadMember(members[0]);
